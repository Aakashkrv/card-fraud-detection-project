import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.metrics import (
classification_report, confusion_matrix,
roc_auc_score, average_precision_score,
RocCurveDisplay, PrecisionRecallDisplay
)
from sklearn.ensemble import RandomForestClassifier, IsolationForest
from sklearn.linear_model import LogisticRegression
from imblearn.over_sampling import SMOTE
from imblearn.pipeline import Pipeline as ImbPipeline
def train_fraud_model(
data_path,
model_name="rf", # "rf", "logreg", or "iso"
target="Class",
test_size=0.2,
smote=True,
random_state=42
):
"""Train and evaluate a fraud detection model."""
# Load dataset
df = pd.read_csv(data_path)
X = df.drop(columns=[target])
y = df[target]
# Train-test split
X_train, X_test, y_train, y_test = train_test_split(
X, y, test_size=test_size, stratify=y,
random_state=random_state
)
numeric_features = X.columns.tolist()
scaler = StandardScaler()
# Choose model
if model_name == "rf":
clf = RandomForestClassifier(n_estimators=300,
class_weight="balanced_subsample", random_state=random_state)
elif model_name == "logreg":
clf = LogisticRegression(max_iter=2000,
class_weight="balanced", random_state=random_state)
elif model_name == "iso":
clf = IsolationForest(n_estimators=200,
contamination="auto", random_state=random_state)
else:
raise ValueError("model_name must be 'rf', 'logreg', or
'iso'")
# Build pipeline
if model_name in {"rf", "logreg"}:
steps = [
("scaler", ColumnTransformer([("num", scaler,
numeric_features)], remainder="drop")),
]
if smote:
steps.append(("smote",
SMOTE(random_state=random_state)))
steps.append(("model", clf))
pipe = ImbPipeline(steps)
pipe.fit(X_train, y_train)
y_pred = pipe.predict(X_test)
y_prob = pipe.predict_proba(X_test)[:,1] if
hasattr(pipe.named_steps["model"], "predict_proba") else None
else: # IsolationForest (unsupervised)
pipe = Pipeline([
("scaler", ColumnTransformer([("num", scaler,
numeric_features)], remainder="drop")),
("model", clf) 
])
pipe.fit(X_train)
raw_pred =
pipe.named_steps["model"].predict(pipe.named_steps["scaler"].transfo
rm(X_test))
y_pred = (raw_pred == -1).astype(int)
y_prob = None
# Evaluation
print(classification_report(y_test, y_pred, digits=4))
print("Confusion Matrix:\n", confusion_matrix(y_test, y_pred))
if y_prob is not None:
print("ROC AUC:", roc_auc_score(y_test, y_prob))
print("PR AUC:", average_precision_score(y_test, y_prob))
RocCurveDisplay.from_predictions(y_test, y_prob)
plt.show()
PrecisionRecallDisplay.from_predictions(y_test, y_prob)
plt.show()
return pipe, (X_test, y_test, y_pred)
pipe, results =
train_fraud_model("Downloads/sample_creditcard_small.csv",
model_name="rf", smote=True)
